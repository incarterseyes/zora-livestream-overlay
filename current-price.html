<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream View</title>
    <style>
        body {
            color: #eee;
            background: #000;
            font-family: DiatypeRounded, BlinkMacSystemFont, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            cursor: pointer;
        }
        #hdr {
            margin: 0;
            padding: 2%;
            display: flex;
            align-items: space-between;
            justify-content: space-around;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 30px;
            z-index: 1000;
            min-width: 400px;
        }
        .modal.open {
            display: block;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        .modal-overlay.open {
            display: block;
        }
        .modal h2 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            background: #333;
            border: 1px solid #555;
            color: #eee;
            border-radius: 4px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #666;
        }
        button.secondary:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="settingsModal">
        <h2>Widget Settings</h2>
        <div class="form-group">
            <label>Font Size (px):</label>
            <input type="number" id="fontSize" value="16">
        </div>
        <div class="form-group">
            <label>Foreground Color:</label>
            <input type="color" id="fgColor" value="#eeeeee">
        </div>
        <div class="form-group">
            <label>Background Color:</label>
            <input type="color" id="bgColor" value="#000000">
        </div>
        <div class="form-group">
            <label>Background Opacity (%):</label>
            <input type="range" id="bgOpacity" min="0" max="100" value="100">
            <span id="opacityValue">100%</span>
        </div>
        <div class="form-group">
            <label>Coin Address:</label>
            <input type="text" id="coinAddress" value="0xfe9ede4478ad200a2186175a81f9ce9f0e679270">
        </div>
        <div class="form-group">
            <label>Chain ID:</label>
            <input type="text" id="chainId" value="8453">
        </div>
        <div class="button-group">
            <button onclick="copyWidgetURL()">Copy Widget URL</button>
            <button class="secondary" onclick="stopEditing()">Preview</button>
        </div>
    </div>

    <h1 id="hdr"><div id="hdr-symbol"></div><div id="hdr-market-cap"></div><div id="hdr-market-cap-delta"></div></h1>

    <script>
        // Default settings
        let settings = {
            fontSize: 16,
            fgColor: '#eeeeee',
            bgColor: '#000000',
            bgOpacity: 100,
            coinAddress: '0xfe9ede4478ad200a2186175a81f9ce9f0e679270',
            chainId: '8453'
        };

        // Parse URL hash parameters
        function parseHashParams() {
            const hash = window.location.hash.substring(1);
            if (!hash) return null;

            const params = new URLSearchParams(hash.replace(/^\?/, ''));
            const parsed = {};

            if (params.has('fontSize')) parsed.fontSize = params.get('fontSize');
            if (params.has('fgColor')) parsed.fgColor = '#' + params.get('fgColor').replace('#', '');
            if (params.has('bgColor')) parsed.bgColor = '#' + params.get('bgColor').replace('#', '');
            if (params.has('bgOpacity')) parsed.bgOpacity = params.get('bgOpacity');
            if (params.has('coinAddress')) parsed.coinAddress = params.get('coinAddress');
            if (params.has('chainId')) parsed.chainId = params.get('chainId');

            return Object.keys(parsed).length > 0 ? parsed : null;
        }

        // Helper function to convert hex color to rgba
        function hexToRgba(hex, opacity) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity / 100})`;
        }

        // Apply settings to the page
        function applySettings() {
            document.body.style.color = settings.fgColor;
            document.body.style.background = hexToRgba(settings.bgColor, settings.bgOpacity);
            document.body.style.fontSize = settings.fontSize + 'px';
        }

        // Generate widget URL
        function generateWidgetURL() {
            const params = new URLSearchParams();
            params.set('fontSize', settings.fontSize);
            params.set('fgColor', settings.fgColor.replace('#', ''));
            params.set('bgColor', settings.bgColor.replace('#', ''));
            params.set('bgOpacity', settings.bgOpacity);
            params.set('coinAddress', settings.coinAddress);
            params.set('chainId', settings.chainId);

            return window.location.origin + window.location.pathname + '#?' + params.toString();
        }

        // Show modal
        function showModal() {
            document.getElementById('settingsModal').classList.add('open');
            document.getElementById('modalOverlay').classList.add('open');

            // Populate form with current settings
            document.getElementById('fontSize').value = settings.fontSize;
            document.getElementById('fgColor').value = settings.fgColor;
            document.getElementById('bgColor').value = settings.bgColor;
            document.getElementById('bgOpacity').value = settings.bgOpacity;
            document.getElementById('opacityValue').textContent = settings.bgOpacity + '%';
            document.getElementById('coinAddress').value = settings.coinAddress;
            document.getElementById('chainId').value = settings.chainId;
        }

        // Update opacity value display when slider changes
        document.addEventListener('DOMContentLoaded', () => {
            const opacitySlider = document.getElementById('bgOpacity');
            const opacityValue = document.getElementById('opacityValue');
            opacitySlider.addEventListener('input', (e) => {
                opacityValue.textContent = e.target.value + '%';
            });
        });

        // Hide modal
        function hideModal() {
            document.getElementById('settingsModal').classList.remove('open');
            document.getElementById('modalOverlay').classList.remove('open');
        }

        // Stop editing - update settings and close modal
        function stopEditing() {
            settings.fontSize = document.getElementById('fontSize').value;
            settings.fgColor = document.getElementById('fgColor').value;
            settings.bgColor = document.getElementById('bgColor').value;
            settings.bgOpacity = document.getElementById('bgOpacity').value;
            settings.coinAddress = document.getElementById('coinAddress').value;
            settings.chainId = document.getElementById('chainId').value;

            applySettings();
            window.location.hash = '#?' + new URLSearchParams({
                fontSize: settings.fontSize,
                fgColor: settings.fgColor.replace('#', ''),
                bgColor: settings.bgColor.replace('#', ''),
                bgOpacity: settings.bgOpacity,
                coinAddress: settings.coinAddress,
                chainId: settings.chainId
            }).toString();

            hideModal();
            fetchData();
        }

        // Copy widget URL to clipboard
        function copyWidgetURL() {
            settings.fontSize = document.getElementById('fontSize').value;
            settings.fgColor = document.getElementById('fgColor').value;
            settings.bgColor = document.getElementById('bgColor').value;
            settings.bgOpacity = document.getElementById('bgOpacity').value;
            settings.coinAddress = document.getElementById('coinAddress').value;
            settings.chainId = document.getElementById('chainId').value;

            const url = generateWidgetURL();
            navigator.clipboard.writeText(url).then(() => {
                alert('Widget URL copied to clipboard!');
            });
        }

        // Click anywhere to open modal
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('.modal') && !e.target.closest('button')) {
                showModal();
            }
        });

        function formatMarketCap(marketCap) {
            return parseFloat(marketCap).toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            });
        }

        function formatDelta(delta) {
            return parseFloat(delta).toLocaleString('en-US', {
                style: 'percent',
                maximumFractionDigits: 2
            });
        }

        /**
         * Returns the % change given the current value, and the value delta
         * @param currentValue - The current value
         * @param deltaValue - The change in value
         * @returns The % change
         */
        function calculatePercentageChange(currentValue, deltaValue) {
            const currentFloat = parseFloat(currentValue);
            const deltaFloat = parseFloat(deltaValue);

            // protect against non-numbers
            if (isNaN(currentFloat) || isNaN(deltaFloat)) {
                return 0;
            }

            // even if the base value is negative, we are interested in the change in value relative to the
            // magnitude (or absolute value) of the base value
            // (this prevents flipping the sign of the percentage when going from negative base to positive current)
            const baseValue = Math.abs(currentFloat - deltaFloat);

            // protect against division by 0
            // if the base value is 0, then we cannot calculate a relative change (relative to 0 is non-sensical)
            if (baseValue === 0) {
                return 0;
            }

            // return the percentage change
            return (deltaFloat / baseValue) * 100;
        }

        const fetchData = async () => {
            const response = await fetch(`https://api-sdk.zora.engineering/coin?address=${settings.coinAddress}&chain=${settings.chainId}`);
            const data = await response.json();

            document.getElementById('hdr-symbol').innerHTML = `$${data.zora20Token.symbol}`;
            document.getElementById('hdr-market-cap').innerHTML = `${formatMarketCap(data.zora20Token.marketCap)}`;

            const marketCapDeltaPercent = calculatePercentageChange(
                data.zora20Token.marketCap,
                data.zora20Token.marketCapDelta24h
            );

            document.getElementById('hdr-market-cap-delta').innerHTML = `${formatDelta(marketCapDeltaPercent / 100)}`;
        }

        // Initialize on page load
        const hashParams = parseHashParams();
        if (hashParams) {
            // Update settings from URL
            settings = { ...settings, ...hashParams };
            applySettings();
            fetchData();
        } else {
            // No parameters, show modal immediately
            showModal();
        }

        // Refresh data every 5 seconds
        setInterval(fetchData, 5000);
    </script>
</body>
</html>